# 阶段一：基础框架 - 详细任务清单

## ? 任务概览
**预计时间**: 1-2周  
**目标**: 搭建项目基础结构，实现WebSocket通信、JSON消息处理和日志系统

---

## 任务1：搭建项目结构

### 1.1 创建目录结构
**时间**: 30分钟  
**输入**: 架构方案文档  
**输出**: 完整的项目目录结构

**具体步骤**:
- [ ] 创建 `src/` 目录及子目录
  - [ ] `src/communication/` - 通信模块
  - [ ] `src/game_logic/` - 游戏逻辑模块
  - [ ] `src/decision/` - 决策引擎模块
  - [ ] `src/data/` - 数据收集模块
  - [ ] `src/monitor/` - 信息监控模块
  - [ ] `src/utils/` - 工具模块
- [ ] 创建 `tests/` 目录
- [ ] 创建 `data/` 目录及子目录
  - [ ] `data/replays/` - 回放文件
  - [ ] `data/platform_info/` - 平台信息存储
- [ ] 创建 `logs/` 目录

### 1.2 创建基础文件
**时间**: 1小时  
**输入**: 架构方案、开发规范  
**输出**: 配置文件、依赖文件

**具体步骤**:
- [ ] 创建 `requirements.txt` - Python依赖包列表
- [ ] 创建 `config.yaml.example` - 配置文件模板
- [ ] 创建 `.gitignore` - Git忽略文件
- [ ] 创建各模块的 `__init__.py` 文件

---

## 任务2：实现WebSocket通信模块

### 2.1 WebSocket客户端基础类
**时间**: 2-3小时  
**输入**: 架构方案、平台文档  
**输出**: `src/communication/websocket_client.py`

**功能要求**:
- [ ] 实现 `WebSocketClient` 类
- [ ] 实现 `connect(url: str) -> bool` 方法
- [ ] 实现 `send(message: dict) -> bool` 方法
- [ ] 实现 `receive() -> dict` 方法
- [ ] 实现 `disconnect()` 方法
- [ ] 实现 `is_connected() -> bool` 方法
- [ ] 实现 `reconnect() -> bool` 方法（重连功能）
- [ ] 支持本地连接：`ws://127.0.0.1:23456/game/{user_info}`
- [ ] 支持局域网连接：`ws://[IP]:23456/game/{user_info}`
- [ ] 实现心跳保活机制
- [ ] 实现连接超时处理
- [ ] 实现异常处理和错误恢复

**技术要点**:
- 使用 `websockets` 或 `websocket-client` 库
- 异步处理（推荐使用 `asyncio`）
- 连接状态管理
- 错误重试机制

### 2.2 连接测试
**时间**: 1小时  
**输入**: WebSocket客户端代码  
**输出**: 测试脚本和测试结果

**测试内容**:
- [ ] 本地连接测试
- [ ] 连接断开测试
- [ ] 重连功能测试
- [ ] 心跳保活测试

---

## 任务3：实现JSON消息处理

### 3.1 消息处理器类
**时间**: 2-3小时  
**输入**: 平台JSON格式文档  
**输出**: `src/communication/message_handler.py`

**功能要求**:
- [ ] 实现 `MessageHandler` 类
- [ ] 实现 `parse_message(json_str: str) -> dict` 方法
- [ ] 实现 `build_message(message_type: str, data: dict) -> str` 方法
- [ ] 实现 `validate_message(message: dict) -> bool` 方法
- [ ] 实现消息类型路由功能
- [ ] 支持所有平台消息类型：
  - [ ] 游戏开始消息
  - [ ] 发牌消息
  - [ ] 出牌请求消息
  - [ ] 游戏状态更新消息
  - [ ] 游戏结束消息

**技术要点**:
- 严格按照平台JSON格式要求
- JSON解析和构建
- 消息格式验证
- 错误处理

### 3.2 消息处理测试
**时间**: 1小时  
**输入**: 消息处理器代码、平台JSON示例  
**输出**: 测试脚本和测试结果

**测试内容**:
- [ ] JSON解析测试
- [ ] JSON构建测试
- [ ] 消息格式验证测试
- [ ] 错误消息处理测试

---

## 任务4：实现基础日志系统

### 4.1 日志工具类
**时间**: 1-2小时  
**输入**: 开发规范文档  
**输出**: `src/utils/logger.py`

**功能要求**:
- [ ] 实现 `Logger` 类或使用标准库 `logging`
- [ ] 实现日志配置功能
- [ ] 支持日志级别：DEBUG/INFO/WARNING/ERROR
- [ ] 实现文件日志输出（`logs/ai_client.log`）
- [ ] 实现控制台日志输出（可选）
- [ ] **重要**: 日志时间戳必须使用 `datetime.now()`（系统时间）
- [ ] 实现日志格式化
- [ ] 实现日志轮转（可选）

**技术要点**:
- 使用 Python `logging` 标准库
- 配置文件支持（从 `config.yaml` 读取）
- 时间处理必须使用系统时间API
- 日志格式统一

### 4.2 日志系统测试
**时间**: 30分钟  
**输入**: 日志工具代码  
**输出**: 测试脚本和测试结果

**测试内容**:
- [ ] 不同级别日志输出测试
- [ ] 文件日志写入测试
- [ ] 控制台日志输出测试
- [ ] 时间戳正确性测试（必须使用系统时间）

---

## 任务5：创建主程序入口

### 5.1 主程序框架
**时间**: 1-2小时  
**输入**: 架构方案  
**输出**: `main.py`

**功能要求**:
- [ ] 创建 `main.py` 文件
- [ ] 实现配置加载功能
- [ ] 实现日志初始化
- [ ] 实现WebSocket客户端初始化
- [ ] 实现主循环框架
- [ ] 实现优雅退出处理
- [ ] 实现命令行参数解析（可选）

**代码结构**:
```python
# main.py 基本框架
def main():
    # 1. 加载配置
    # 2. 初始化日志
    # 3. 初始化WebSocket客户端
    # 4. 连接平台
    # 5. 主循环（接收消息、处理消息）
    # 6. 优雅退出
```

---

## 任务6：配置文件管理

### 6.1 配置加载工具
**时间**: 1小时  
**输入**: 架构方案中的配置结构  
**输出**: `src/utils/config.py`

**功能要求**:
- [ ] 实现 `Config` 类
- [ ] 实现 `load_config(config_path: str) -> dict` 方法
- [ ] 支持 YAML 格式配置文件
- [ ] 实现配置验证
- [ ] 实现默认配置值

### 6.2 创建配置文件模板
**时间**: 30分钟  
**输入**: 架构方案中的配置示例  
**输出**: `config.yaml.example`

**配置内容**:
- [ ] 平台配置
- [ ] WebSocket配置
- [ ] AI策略配置
- [ ] 日志配置
- [ ] 信息监控配置（可选，阶段五实现）

---

## 任务7：集成测试

### 7.1 基础功能集成测试
**时间**: 2-3小时  
**输入**: 所有阶段一模块  
**输出**: 集成测试脚本和测试报告

**测试内容**:
- [ ] 配置加载测试
- [ ] 日志系统集成测试
- [ ] WebSocket连接集成测试
- [ ] JSON消息处理集成测试
- [ ] 完整流程测试（连接→接收消息→发送消息→断开）

---

## ? 阶段一完成标准

### 必须完成的功能
- ? 项目目录结构完整
- ? WebSocket可以成功连接平台
- ? 可以接收和发送JSON消息
- ? 日志系统正常工作
- ? 主程序可以运行

### 验收标准
- [ ] 可以连接到本地平台（`ws://127.0.0.1:23456`）
- [ ] 可以接收平台发送的消息
- [ ] 可以发送符合格式的JSON消息
- [ ] 日志文件正常生成
- [ ] 代码通过基础测试

---

## ?? 注意事项

### 开发规范
1. **时间处理**: 所有涉及时间的代码必须使用 `datetime.now()`，禁止硬编码
2. **JSON格式**: 严格按照平台JSON格式要求
3. **错误处理**: 所有可能失败的操作都要有异常处理
4. **代码规范**: 遵循 PEP 8，使用类型提示

### 技术要点
- WebSocket使用异步IO提高性能
- JSON消息格式必须完全符合平台要求
- 日志时间戳必须使用系统时间
- 配置文件使用YAML格式

---

## ? 任务依赖关系

```
任务1（项目结构）
  ↓
任务2（WebSocket） + 任务3（JSON处理） + 任务4（日志系统）
  ↓
任务5（主程序）
  ↓
任务6（配置管理）
  ↓
任务7（集成测试）
```

---

**文档版本**: v1.0  
**注意**: 文档中的时间信息应使用系统时间API获取，禁止硬编码时间

